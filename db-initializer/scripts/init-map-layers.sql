CREATE SCHEMA map_layers;

CREATE TABLE map_layers.beach (
    id SERIAL PRIMARY KEY,
    geom geometry(Polygon, 3857)
);
INSERT INTO map_layers.beach (geom)
        SELECT 
          way AS geom
        FROM osm.planet_osm_polygon
        WHERE "natural" = 'beach';
CREATE INDEX idx_beach_geom ON map_layers.beach USING GIST(geom);

CREATE TABLE map_layers.building (
    id SERIAL PRIMARY KEY,
    geom geometry(Polygon, 3857),
    height int
);
INSERT INTO map_layers.building (geom, height)
    SELECT 
      way AS geom,
      coalesce(
        CASE WHEN tags->'building:levels' ~ '^[0-9]+$' THEN (tags->'building:levels')::int * 3 END,
        3
      ) as height
    FROM osm.planet_osm_polygon
    WHERE building IS NOT NULL AND (tags->'name:en' IS NULL OR tags->'name:en' <> 'Burj Khalifa');
CREATE INDEX idx_building_geom ON map_layers.building USING GIST(geom);

CREATE TABLE map_layers.building_label (
    id SERIAL PRIMARY KEY,
    geom geometry(Point, 3857),
    housenumber text
);
INSERT INTO map_layers.building_label (geom, housenumber)
    SELECT 
      ST_AsGeoJSON(ST_Centroid(way)) AS geom,
      "addr:housenumber" as housenumber
    FROM osm.planet_osm_polygon
    WHERE building IS NOT NULL;
CREATE INDEX idx_building_label_geom ON map_layers.building_label USING GIST(geom);

CREATE TABLE map_layers.burjkhalifa (
    id SERIAL PRIMARY KEY,
    geom geometry(Polygon, 3857),
    name text,
    extrusion_base float,
    height float
);

INSERT INTO map_layers.burjkhalifa (geom, name, height) 
    SELECT way as geom, 'Base'as name, 18 as height
    FROM osm.planet_osm_polygon WHERE tags->'name:en'='Burj Khalifa';
INSERT INTO map_layers.burjkhalifa (name, height, geom) VALUES
    ('Tier-0', 81,
        '{"type":"Polygon","coordinates":[[[6153052.788497247733176,2900015.566253495868295],[6153063.406650700606406,2900019.593828943558037],[6153092.319692641496658,2900005.166923712007701],[6153128.139748645946383,2900012.3605972295627],[6153136.341417990624905,2900006.190419735386968],[6153137.052399651147425,2899997.746995634399354],[6153103.888489696197212,2899977.788587935268879],[6153094.412369318306446,2899940.981004757806659],[6153086.542410245165229,2899938.839519295375794],[6153077.815856986679137,2899942.961878810077906],[6153075.634303430095315,2899980.679967543575913],[6153050.338593647815287,2900006.06581674516201],[6153052.788497247733176,2900015.566253495868295]]]}'),
    ('Tier-1', 117,
        '{"type":"Polygon","coordinates":[[[6153061.1387740354985,2900009.947836115956306],[6153070.210073994472623,2900016.208617281634361],[6153092.319692641496658,2900005.166923712007701],[6153128.139748645946383,2900012.3605972295627],[6153136.341417990624905,2900006.190419735386968],[6153137.052399651147425,2899997.746995634399354],[6153103.888489696197212,2899977.788587935268879],[6153094.412369318306446,2899940.981004757806659],[6153086.542410245165229,2899938.839519295375794],[6153077.815856986679137,2899942.961878810077906],[6153075.634303430095315,2899980.679967543575913],[6153056.904012437909842,2899999.410714303608984],[6153061.1387740354985,2900009.947836115956306]]]}'),
    ('Tier-2', 153,
        '{"type":"Polygon","coordinates":[[[6153061.1387740354985,2900009.947836115956306],[6153070.210073994472623,2900016.208617281634361],[6153092.319692641496658,2900005.166923712007701],[6153116.872184310108423,2900010.167208482511342],[6153126.246671172790229,2900001.94803752284497],[6153127.827225268818438,2899992.262298318557441],[6153103.888489696197212,2899977.788587935268879],[6153094.412369318306446,2899940.981004757806659],[6153086.542410245165229,2899938.839519295375794],[6153077.815856986679137,2899942.961878810077906],[6153075.634303430095315,2899980.679967543575913],[6153056.904012437909842,2899999.410714303608984],[6153061.1387740354985,2900009.947836115956306]]]}'),
    ('Tier-3', 189,
        '{"type":"Polygon","coordinates":[[[6153061.1387740354985,2900009.947836115956306],[6153070.210073994472623,2900016.208617281634361],[6153092.319692641496658,2900005.166923712007701],[6153116.872184310108423,2900010.167208482511342],[6153126.246671172790229,2900001.94803752284497],[6153127.827225268818438,2899992.262298318557441],[6153103.888489696197212,2899977.788587935268879],[6153097.109457631595433,2899951.520848966669291],[6153087.406649297103286,2899950.133909429889172],[6153077.187863279134035,2899953.851872834842652],[6153075.634303430095315,2899980.679967543575913],[6153056.904012437909842,2899999.410714303608984],[6153061.1387740354985,2900009.947836115956306]]]}'),
    ('Tier-4', 234,
        '{"type":"Polygon","coordinates":[[[6153065.585092448629439,2900006.073732185643166],[6153072.285491074435413,2900010.495757175609469],[6153078.814202130772173,2900011.903424550779164],[6153092.319692641496658,2900005.166923712007701],[6153116.872184310108423,2900010.167208482511342],[6153126.246671172790229,2900001.94803752284497],[6153127.827225268818438,2899992.262298318557441],[6153103.888489696197212,2899977.788587935268879],[6153097.109457631595433,2899951.520848966669291],[6153087.406649297103286,2899950.133909429889172],[6153077.187863279134035,2899953.851872834842652],[6153075.634303430095315,2899980.679967543575913],[6153062.507193777710199,2899993.743843104690313],[6153062.703795105218887,2899999.046938731335104],[6153065.585092448629439,2900006.073732185643166]]]}'),
    ('Tier-5', 283.5,
        '{"type":"Polygon","coordinates":[[[6153065.585092448629439,2900006.073732185643166],[6153072.285491074435413,2900010.495757175609469],[6153078.814202130772173,2900011.903424550779164],[6153092.319692641496658,2900005.166923712007701],[6153109.839969839900732,2900008.719201849773526],[6153115.66732928995043,2900005.016333914827555],[6153120.130738737992942,2899999.543407782446593],[6153121.601160644553602,2899993.458971411921084],[6153121.036217213608325,2899988.15636749798432],[6153103.888489696197212,2899977.788587935268879],[6153097.109457631595433,2899951.520848966669291],[6153087.406649297103286,2899950.133909429889172],[6153077.187863279134035,2899953.851872834842652],[6153075.634303430095315,2899980.679967543575913],[6153062.507193777710199,2899993.743843104690313],[6153062.703795105218887,2899999.046938731335104],[6153065.585092448629439,2900006.073732185643166]]]}'),
    ('Tier-6', 337.5,
        '{"type":"Polygon","coordinates":[[[6153065.585092448629439,2900006.073732185643166],[6153072.285491074435413,2900010.495757175609469],[6153078.814202130772173,2900011.903424550779164],[6153092.319692641496658,2900005.166923712007701],[6153109.839969839900732,2900008.719201849773526],[6153115.66732928995043,2900005.016333914827555],[6153120.130738737992942,2899999.543407782446593],[6153121.601160644553602,2899993.458971411921084],[6153121.036217213608325,2899988.15636749798432],[6153103.888489696197212,2899977.788587935268879],[6153099.559919212944806,2899961.009900674689561],[6153093.948657584376633,2899958.318181034643203],[6153088.041594009846449,2899957.688865470699966],[6153080.560768435709178,2899960.195006731897593],[6153076.647797660902143,2899963.085669826716185],[6153075.634303430095315,2899980.679967543575913],[6153062.507193777710199,2899993.743843104690313],[6153062.703795105218887,2899999.046938731335104],[6153065.585092448629439,2900006.073732185643166]]]}'),
    ('Tier-7', 387,
        '{"type":"Polygon","coordinates":[[[6153070.053136775270104,2900002.81203628750518],[6153073.77376979123801,2900004.814869307447225],[6153077.319357003085315,2900006.20355763239786],[6153081.042223575524986,2900007.030861315317452],[6153084.558264227584004,2900007.0604078755714],[6153087.865953736007214,2900006.67902581486851],[6153092.319692641496658,2900005.166923712007701],[6153109.839969839900732,2900008.719201849773526],[6153115.66732928995043,2900005.016333914827555],[6153120.130738737992942,2899999.543407782446593],[6153121.601160644553602,2899993.458971411921084],[6153121.036217213608325,2899988.15636749798432],[6153103.888489696197212,2899977.788587935268879],[6153099.559919212944806,2899961.009900674689561],[6153093.948657584376633,2899958.318181034643203],[6153088.041594009846449,2899957.688865470699966],[6153080.560768435709178,2899960.195006731897593],[6153076.647797660902143,2899963.085669826716185],[6153075.634303430095315,2899980.679967543575913],[6153072.432974345982075,2899984.443283181171864],[6153070.296144887804985,2899987.601675285957754],[6153069.05773666780442,2899991.274444136768579],[6153068.798781367950141,2899995.391596544999629],[6153069.316813127137721,2899999.017818856984377],[6153070.053136775270104,2900002.81203628750518]]]}'),
    ('Tier-8', 441,
        '{"type":"Polygon","coordinates":[[[6153070.053136775270104,2900002.81203628750518],[6153073.77376979123801,2900004.814869307447225],[6153077.319357003085315,2900006.20355763239786],[6153081.042223575524986,2900007.030861315317452],[6153084.558264227584004,2900007.0604078755714],[6153087.865953736007214,2900006.67902581486851],[6153092.319692641496658,2900005.166923712007701],[6153098.059363454580307,2900005.773718033451587],[6153102.628335717134178,2900005.697114937007427],[6153106.902906588278711,2900004.759317685384303],[6153111.191148607991636,2900002.397679144050926],[6153113.802146525122225,2900000.272448280826211],[6153116.272974162362516,2899997.930643734522164],[6153116.133862824179232,2899994.780349483713508],[6153115.760537506081164,2899991.728030381724238],[6153114.57843176741153,2899987.439852461218834],[6153112.291685778647661,2899984.558489741757512],[6153108.966159197501838,2899981.592780285514891],[6153103.888489696197212,2899977.788587935268879],[6153099.559919212944806,2899961.009900674689561],[6153093.948657584376633,2899958.318181034643203],[6153088.041594009846449,2899957.688865470699966],[6153080.560768435709178,2899960.195006731897593],[6153076.647797660902143,2899963.085669826716185],[6153075.634303430095315,2899980.679967543575913],[6153072.432974345982075,2899984.443283181171864],[6153070.296144887804985,2899987.601675285957754],[6153069.05773666780442,2899991.274444136768579],[6153068.798781367950141,2899995.391596544999629],[6153069.316813127137721,2899999.017818856984377],[6153070.053136775270104,2900002.81203628750518]]]}'),
    ('Tier-9', 495,
        '{"type":"Polygon","coordinates":[[[6153070.053136775270104,2900002.81203628750518],[6153073.77376979123801,2900004.814869307447225],[6153077.319357003085315,2900006.20355763239786],[6153081.042223575524986,2900007.030861315317452],[6153084.558264227584004,2900007.0604078755714],[6153087.865953736007214,2900006.67902581486851],[6153092.319692641496658,2900005.166923712007701],[6153098.059363454580307,2900005.773718033451587],[6153102.628335717134178,2900005.697114937007427],[6153106.902906588278711,2900004.759317685384303],[6153111.191148607991636,2900002.397679144050926],[6153113.802146525122225,2900000.272448280826211],[6153116.272974162362516,2899997.930643734522164],[6153116.133862824179232,2899994.780349483713508],[6153115.760537506081164,2899991.728030381724238],[6153114.57843176741153,2899987.439852461218834],[6153112.291685778647661,2899984.558489741757512],[6153108.966159197501838,2899981.592780285514891],[6153103.888489696197212,2899977.788587935268879],[6153101.8633768921718,2899972.700670237187296],[6153100.467980767600238,2899970.137805810663849],[6153098.928090824745595,2899967.937963034491986],[6153096.564097792841494,2899965.697765404358506],[6153093.139636545442045,2899963.906015864107758],[6153088.414895105175674,2899962.485801007598639],[6153084.981700289994478,2899964.163619117811322],[6153081.651363332755864,2899966.138533406890929],[6153079.181258673779666,2899968.481668915133923],[6153077.537471737712622,2899971.962629484478384],[6153076.605796401388943,2899975.760962907224894],[6153075.634303430095315,2899980.679967543575913],[6153072.432974345982075,2899984.443283181171864],[6153070.296144887804985,2899987.601675285957754],[6153069.05773666780442,2899991.274444136768579],[6153068.798781367950141,2899995.391596544999629],[6153069.316813127137721,2899999.017818856984377],[6153070.053136775270104,2900002.81203628750518]]]}'),
    ('Tier-10', 553.5,
        '{ "type": "Polygon", "coordinates": [ [ [ 6153084.265499284490943, 2899992.411289807409048 ], [ 6153085.355404669418931, 2899994.089744100812823 ], [ 6153086.095346566289663, 2899995.8754594582133 ], [ 6153086.991974659264088, 2899998.719934785272926 ], [ 6153088.605695272795856, 2900002.129771060310304 ], [ 6153090.525918269529939, 2900004.51190319377929 ], [ 6153092.319692641496658, 2900005.166923712007701 ], [ 6153098.059363454580307, 2900005.773718033451587 ], [ 6153102.628335717134178, 2900005.697114937007427 ], [ 6153106.902906588278711, 2900004.759317685384303 ], [ 6153111.191148607991636, 2900002.397679144050926 ], [ 6153113.802146525122225, 2900000.272448280826211 ], [ 6153116.272974162362516, 2899997.930643734522164 ], [ 6153116.133862824179232, 2899994.780349483713508 ], [ 6153115.760537506081164, 2899991.728030381724238 ], [ 6153114.57843176741153, 2899987.439852461218834 ], [ 6153112.291685778647661, 2899984.558489741757512 ], [ 6153108.966159197501838, 2899981.592780285514891 ], [ 6153103.888489696197212, 2899977.788587935268879 ], [ 6153101.8633768921718, 2899972.700670237187296 ], [ 6153100.467980767600238, 2899970.137805810663849 ], [ 6153098.928090824745595, 2899967.937963034491986 ], [ 6153096.564097792841494, 2899965.697765404358506 ], [ 6153093.139636545442045, 2899963.906015864107758 ], [ 6153088.414895105175674, 2899962.485801007598639 ], [ 6153084.981700289994478, 2899964.163619117811322 ], [ 6153081.651363332755864, 2899966.138533406890929 ], [ 6153079.181258673779666, 2899968.481668915133923 ], [ 6153077.537471737712622, 2899971.962629484478384 ], [ 6153076.605796401388943, 2899975.760962907224894 ], [ 6153075.634303430095315, 2899980.679967543575913 ], [ 6153075.853634773753583, 2899983.160385984927416 ], [ 6153077.08561144862324, 2899986.018908055033535 ], [ 6153079.042159861885011, 2899988.15097320266068 ], [ 6153081.055678323842585, 2899989.970081333536655 ], [ 6153082.972607349045575, 2899991.175891526509076 ], [ 6153084.265499284490943, 2899992.411289807409048 ] ] ] }'),
    ('Tier-11', 621,
        '{"type":"Polygon","coordinates":[[[6153084.265499284490943,2899992.411289807409048],[6153085.355404669418931,2899994.089744100812823],[6153086.095346566289663,2899995.8754594582133],[6153086.991974659264088,2899998.719934785272926],[6153088.605695272795856,2900002.129771060310304],[6153090.525918269529939,2900004.51190319377929],[6153092.319692641496658,2900005.166923712007701],[6153094.355667115189135,2900003.411126094870269],[6153095.77205434255302,2900000.096568203996867],[6153096.608878530561924,2899997.476626774296165],[6153097.023135491646826,2899995.599651957862079],[6153097.605462713167071,2899993.255514851305634],[6153098.833552655763924,2899990.26784574938938],[6153100.523624543100595,2899988.331751508638263],[6153101.700758089311421,2899986.251257414463907],[6153102.875007200054824,2899984.319428231101483],[6153103.746224283240736,2899982.160325026605278],[6153104.04925631172955,2899980.228495843708515],[6153103.888489696197212,2899977.788587935268879],[6153101.8633768921718,2899972.700670237187296],[6153100.467980767600238,2899970.137805810663849],[6153098.928090824745595,2899967.937963034491986],[6153096.564097792841494,2899965.697765404358506],[6153093.139636545442045,2899963.906015864107758],[6153088.414895105175674,2899962.485801007598639],[6153084.981700289994478,2899964.163619117811322],[6153081.651363332755864,2899966.138533406890929],[6153079.181258673779666,2899968.481668915133923],[6153077.537471737712622,2899971.962629484478384],[6153076.605796401388943,2899975.760962907224894],[6153075.634303430095315,2899980.679967543575913],[6153075.853634773753583,2899983.160385984927416],[6153077.08561144862324,2899986.018908055033535],[6153079.042159861885011,2899988.15097320266068],[6153081.055678323842585,2899989.970081333536655],[6153082.972607349045575,2899991.175891526509076],[6153084.265499284490943,2899992.411289807409048]]]}'),
    ('Tier-12', 643.5,
        '{"type":"Polygon","coordinates":[[[6153084.265499284490943,2899992.411289807409048],[6153085.355404669418931,2899994.089744100812823],[6153086.095346566289663,2899995.8754594582133],[6153086.991974659264088,2899998.719934785272926],[6153088.605695272795856,2900002.129771060310304],[6153090.525918269529939,2900004.51190319377929],[6153092.319692641496658,2900005.166923712007701],[6153094.355667115189135,2900003.411126094870269],[6153095.77205434255302,2900000.096568203996867],[6153096.608878530561924,2899997.476626774296165],[6153097.023135491646826,2899995.599651957862079],[6153097.605462713167071,2899993.255514851305634],[6153098.833552655763924,2899990.26784574938938],[6153100.523624543100595,2899988.331751508638263],[6153101.700758089311421,2899986.251257414463907],[6153102.875007200054824,2899984.319428231101483],[6153103.746224283240736,2899982.160325026605278],[6153104.04925631172955,2899980.228495843708515],[6153103.888489696197212,2899977.788587935268879],[6153102.004607388749719,2899977.719896390568465],[6153100.150860195979476,2899977.80415762681514],[6153098.294871268793941,2899977.940564254764467],[6153095.703683538362384,2899978.235496191307902],[6153092.75436417106539,2899978.804293498396873],[6153089.912572266533971,2899979.688333518337458],[6153086.470451109111309,2899979.149503062013537],[6153083.551200773566961,2899979.000751452986151],[6153080.916133223101497,2899979.203368502203375],[6153078.851964816451073,2899979.690507211256772],[6153077.249726397916675,2899979.988252002745867],[6153075.634303430095315,2899980.679967543575913],[6153075.853634773753583,2899983.160385984927416],[6153077.08561144862324,2899986.018908055033535],[6153079.042159861885011,2899988.15097320266068],[6153081.055678323842585,2899989.970081333536655],[6153082.972607349045575,2899991.175891526509076],[6153084.265499284490943,2899992.411289807409048]]]}'),
    ('Tier-13', 661.5,
        '{"type":"Polygon","coordinates":[[[6153081.250528573058546,2899988.462397278752178],[6153082.535070629790425,2899988.992525746580213],[6153083.905746642500162,2899989.534576636273414],[6153085.11568802408874,2899990.057794530875981],[6153086.521836115047336,2899990.482909069862217],[6153088.509210671298206,2899990.94992316653952],[6153090.955957445316017,2899991.174208287149668],[6153093.606599784456193,2899990.521742480807006],[6153095.258153857663274,2899989.787718448322266],[6153096.379579463042319,2899989.196421311236918],[6153097.419446841813624,2899988.421618165913969],[6153098.308784894645214,2899987.740693788975477],[6153099.182890847325325,2899986.905906356871128],[6153100.332758175209165,2899985.953660821542144],[6153101.358295143581927,2899984.705924177076668],[6153102.281266867183149,2899983.545360058546066],[6153103.204261685721576,2899981.936974363401532],[6153103.82445843424648,2899980.189972768072039],[6153103.888489696197212,2899977.788587935268879],[6153102.004607388749719,2899977.719896390568465],[6153100.150860195979476,2899977.80415762681514],[6153098.294871268793941,2899977.940564254764467],[6153095.703683538362384,2899978.235496191307902],[6153092.75436417106539,2899978.804293498396873],[6153089.912572266533971,2899979.688333518337458],[6153086.470451109111309,2899979.149503062013537],[6153083.551200773566961,2899979.000751452986151],[6153080.916133223101497,2899979.203368502203375],[6153078.851964816451073,2899979.690507211256772],[6153077.249726397916675,2899979.988252002745867],[6153075.634303430095315,2899980.679967543575913],[6153075.853634773753583,2899983.160385984927416],[6153076.603762792423368,2899984.54437424056232],[6153077.676612719893456,2899985.909819602966309],[6153079.017675129696727,2899987.007052483502775],[6153080.358737538568676,2899987.83607288217172],[6153081.250528573058546,2899988.462397278752178]]]}'),
    ('Tier-14', 679.5,
        '{"type":"Polygon","coordinates":[[[6153081.250528573058546,2899988.462397278752178],[6153082.535070629790425,2899988.992525746580213],[6153083.905746642500162,2899989.534576636273414],[6153085.11568802408874,2899990.057794530875981],[6153086.521836115047336,2899990.482909069862217],[6153088.509210671298206,2899990.94992316653952],[6153090.979026710614562,2899991.027444577775896],[6153092.114162499085069,2899990.832052352372557],[6153093.342342204414308,2899990.525007425807416],[6153094.048333828337491,2899990.222017483320087],[6153094.835745031945407,2899989.890946863219142],[6153095.605754625983536,2899989.488959023263305],[6153096.156909669749439,2899989.048034988343716],[6153096.653331524692476,2899988.523675728589296],[6153097.086181297898293,2899987.857753001153469],[6153097.199380460195243,2899986.943390598054975],[6153097.186332319863141,2899985.912587480153888],[6153096.794888097792864,2899984.777399235870689],[6153096.050015474669635,2899983.284711917396635],[6153095.088142442516983,2899982.432767231483012],[6153094.153751496225595,2899981.58082254556939],[6153093.026985944248736,2899981.003698725719005],[6153091.900220392271876,2899980.509021166246384],[6153091.020793619565666,2899980.151754039805382],[6153089.912572266533971,2899979.688333518337458],[6153086.470451109111309,2899979.149503062013537],[6153083.551200773566961,2899979.000751452986151],[6153080.916133223101497,2899979.203368502203375],[6153078.851964816451073,2899979.690507211256772],[6153077.249726397916675,2899979.988252002745867],[6153075.634303430095315,2899980.679967543575913],[6153075.853634773753583,2899983.160385984927416],[6153076.603762792423368,2899984.54437424056232],[6153077.676612719893456,2899985.909819602966309],[6153079.017675129696727,2899987.007052483502775],[6153080.358737538568676,2899987.83607288217172],[6153081.250528573058546,2899988.462397278752178]]]}'),
    ('Tier-15', 715,
        '{"type":"Polygon","coordinates":[[[6153089.949673312716186,2899981.104941317345947],[6153088.017323266714811,2899981.63942111749202],[6153086.845579089596868,2899983.057848279364407],[6153085.735505658201873,2899984.764072256162763],[6153085.858847150579095,2899986.778649964369833],[6153086.454997696913779,2899988.217634041327983],[6153087.545719106681645,2899989.261316092684865],[6153089.062811335548759,2899989.908371488098055],[6153091.088803850114346,2899989.959796901792288],[6153093.019313764758408,2899989.301124053541571],[6153094.201685045845807,2899988.548669494688511],[6153095.248559588566422,2899987.032070268411189],[6153095.323865790851414,2899984.947842557448894],[6153094.731056093238294,2899983.528969687409699],[6153093.915969819761813,2899982.435289747547358],[6153092.03155521210283,2899981.352292846422642],[6153089.949673312716186,2899981.104941317345947]]]}'),
    ('Tier-16', 760,
        '{"type":"Polygon","coordinates":[[[6153091.603636752814054,2899983.441025495529175],[6153090.33610556088388,2899983.293146856129169],[6153089.026323328725994,2899983.462151015177369],[6153087.991172854788601,2899984.835309807211161],[6153087.885545254684985,2899986.377472757827491],[6153088.836193649098277,2899987.898510188795626],[6153089.681214444339275,2899988.299895066767931],[6153090.547360759228468,2899988.595652344636619],[6153091.624762273393571,2899988.447773705702275],[6153092.512034107930958,2899987.792882589623332],[6153092.913418984971941,2899987.306995632592589],[6153093.378180422820151,2899986.652104516513646],[6153093.462682502344251,2899985.574703002814204],[6153093.040172104723752,2899984.328297330066562],[6153093.040172104723752,2899984.328297330066562],[6153092.131774749606848,2899983.715657253749669],[6153091.603636752814054,2899983.441025495529175]]]}'),
    ('Tier-17', 828,
        '{ "type": "Polygon", "coordinates": [ [ [ 6153090.506594254635274, 2899988.399402483832091 ], [ 6153090.941580750979483, 2899988.373433141037822 ], [ 6153091.383059583604336, 2899988.217617082409561 ], [ 6153091.779092065058649, 2899987.730691899545491 ], [ 6153091.876477101817727, 2899987.354136425070465 ], [ 6153091.766107393428683, 2899986.925642264541239 ], [ 6153091.415521262213588, 2899986.575056132860482 ], [ 6153091.214258853346109, 2899986.451701753307134 ], [ 6153090.694871991872787, 2899986.360809052363038 ], [ 6153090.227423816919327, 2899986.386778395622969 ], [ 6153089.876837684772909, 2899986.549086789600551 ], [ 6153089.552220896817744, 2899986.932134600356221 ], [ 6153089.532743888907135, 2899987.41905978275463 ], [ 6153089.727513962425292, 2899987.899492629803717 ], [ 6153090.0586230866611, 2899988.178663067985326 ], [ 6153090.285854838788509, 2899988.308509783353657 ], [ 6153090.506594254635274, 2899988.399402483832091 ] ] ] }');


CREATE TABLE map_layers.district (
    id SERIAL PRIMARY KEY,
    geom geometry(Polygon, 3857),
    name text,
    level int
);
INSERT INTO map_layers.district (geom, name, level)
    SELECT 
      way AS geom,
      tags->'name:en' as name,
      admin_level::int as level
    FROM osm.planet_osm_polygon
    WHERE boundary = 'administrative';
CREATE INDEX idx_district ON map_layers.district USING GIST(geom);

DELETE FROM map_layers.district WHERE LEVEL IS NULL;

CREATE TABLE map_layers.district_label (
    id SERIAL PRIMARY KEY,
    geom geometry(Point, 3857),
    name text,
    level int
);
INSERT INTO map_layers.district_label (geom, name, level)
    SELECT 
      ST_AsGeoJSON(ST_Centroid(way)) AS geom,
      tags->'name:en' as name,
      admin_level::int as level
    FROM osm.planet_osm_polygon
    WHERE boundary = 'administrative';
CREATE INDEX idx_district_label ON map_layers.district_label USING GIST(geom);

CREATE TABLE map_layers.label (
    id SERIAL PRIMARY KEY,
    geom geometry(Polygon, 3857),
    type text,
    value text
);
INSERT INTO map_layers.label (geom, type, value)
        SELECT 
          way AS geom,
          'housenumber' as type,
          "addr:housenumber" as value
        FROM osm.planet_osm_polygon
        WHERE "addr:housenumber" IS NOT NULL;
CREATE INDEX idx_label ON map_layers.label USING GIST(geom);

CREATE TABLE map_layers.highway (
    id SERIAL PRIMARY KEY,
    geom geometry(LineString, 3857),
    type text,
    name text
);
INSERT INTO map_layers.highway (geom, type, name)
        SELECT 
          way AS geom,
          highway as type,
          tags->'name:en' as name
        FROM osm.planet_osm_roads
        WHERE highway IN ('trunk', 'primary', 'primary_link', 'motorway_link', 'footway', 'secondary', 'motorway', 'trunk_link');
CREATE INDEX idx_highway ON map_layers.highway USING GIST(geom);

CREATE TABLE map_layers.road (
    id SERIAL PRIMARY KEY,
    geom geometry(LineString, 3857),
    type text,
    name text
);
INSERT INTO map_layers.road (geom, type, name)
        SELECT 
          way AS geom,
          highway as type,
          tags->'name:en' as name
        FROM osm.planet_osm_line
        WHERE highway NOT IN ('trunk', 'primary', 'primary_link', 'motorway_link', 'footway', 'secondary', 'motorway', 'trunk_link');
CREATE INDEX idx_road ON map_layers.road USING GIST(geom);

CREATE TABLE map_layers.water (
    id SERIAL PRIMARY KEY,
    geom geometry(Polygon, 3857)
);
INSERT INTO map_layers.water (geom)
        SELECT 
          way AS geom
        FROM osm.planet_osm_polygon
        WHERE "water" IS NOT NULL OR "natural"='water' OR landuse='reservoir';
CREATE INDEX idx_water_geom ON map_layers.water USING GIST(geom);

CREATE TABLE map_layers.surface (
    id SERIAL PRIMARY KEY,
    geom geometry(Polygon, 3857),
    type text
);
INSERT INTO map_layers.surface (geom, type)
        SELECT 
          way AS geom,
          'vegetation' as type
        FROM osm.planet_osm_polygon
        WHERE "natural" in ('grassland', 'wood', 'tree_row', 'scrub', 'shrub', 'grassland') 
          OR  surface in ('grass_paver', 'grass')
        UNION
        SELECT 
          way AS geom,
          'sand' as type
        FROM osm.planet_osm_polygon
        WHERE surface in ('sandy', 'sand', 'dirt/sand', 'dirt');
CREATE INDEX idx_surface ON map_layers.surface USING GIST(geom);

CREATE TABLE map_layers.ship (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    geom GEOMETRY(Point, 3857) NOT NULL,
    nominal_speed FLOAT NOT NULL,
    type TEXT CHECK (type IN ('CONTAINER_SHIP', 'MOTORBOAT')) NOT NULL,
    state TEXT CHECK (state IN ('arriving', 'departing', 'stop')) NOT NULL,
    angle FLOAT CHECK (angle BETWEEN 0 AND 360) NOT NULL,
    path_start GEOMETRY(Point, 3857) NOT NULL,
    path_end GEOMETRY(Point, 3857) NOT NULL,
    stop_duration INTERVAL NOT NULL,
    last_stop_time TIMESTAMP DEFAULT NOW()
);

WITH RECURSIVE positions AS (
    SELECT
        1 AS id,
        ST_MakePoint(6128868.5283447495, 2881804.877410476)::GEOMETRY(Point, 3857) AS path_start,
        ST_MakePoint(6086463.905457501, 2926138.2328633997)::GEOMETRY(Point, 3857) AS path_end
    UNION ALL
    SELECT
        id + 1,
        ST_LineInterpolatePoint(
            ST_MakeLine(
                ST_MakePoint(6128868.5283447495, 2881804.877410476),
                ST_MakePoint(6127219.968493052, 2880643.2192323024)
            ),
            id / 29.0
        )::GEOMETRY(Point, 3857),
        ST_LineInterpolatePoint(
            ST_MakeLine(
                ST_MakePoint(6088399.405457501, 2924533.2328633997),
                ST_MakePoint(6086650.009877315, 2923373.230690268)
            ),
            id / 29.0
        )::GEOMETRY(Point, 3857)
    FROM positions
    WHERE id < 30
),
types AS (
    SELECT
      1 AS id,
      CASE WHEN random() < 0.3 THEN 'MOTORBOAT' ELSE 'CONTAINER_SHIP' END AS type
    UNION ALL
    SELECT 
      id + 1,
      CASE WHEN random() < 0.3 THEN 'MOTORBOAT' ELSE 'CONTAINER_SHIP' END AS type
    FROM types
    WHERE id < 30
) 
INSERT INTO map_layers.ship (name, geom, type, nominal_speed, state, angle, path_start, path_end, stop_duration, last_stop_time)
SELECT 
    UPPER(substr(md5(random()::text), 0, 6)) AS name,
    CASE 
        WHEN p.id <= 5 THEN p.path_end
        WHEN p.id <= 10 THEN p.path_start
        ELSE ST_LineInterpolatePoint(ST_MakeLine(path_start, path_end), random())
    END AS geom,
    types.type as type,
    CASE WHEN type = 'MOTORBOAT' THEN 20 + (select random()/3 * 10)::int ELSE 10 + (select random()/3 * 10)::int END AS nominal_speed,
    -- CASE WHEN type = 'MOTORBOAT' THEN 500 ELSE 240 END AS nominal_speed,
    CASE 
        WHEN p.id <= 10 THEN 'stop'
        WHEN random() < 0.5 THEN 'departing' 
        ELSE 'arriving'
    END AS state,
    CASE 
        WHEN p.id <= 10 THEN 0
        WHEN random() < 0.5 THEN ST_Azimuth(path_start, path_end) * 180 / pi()
        ELSE ST_Azimuth(path_end, path_start) * 180 / pi()
    END AS angle,
    p.path_start,
    p.path_end,
    INTERVAL '30 minutes' AS stop_duration,
    -- INTERVAL '3 seconds' AS stop_duration,
    NOW() - (random() * INTERVAL '30 minutes') AS last_stop_time
FROM positions p join types on p.id=types.id
ORDER BY random(); 

CREATE OR REPLACE FUNCTION map_layers.update_ship_positions() RETURNS VOID AS $$
BEGIN
    UPDATE map_layers.ship
    SET geom = 
        CASE
            WHEN state = 'departing' THEN ST_LineInterpolatePoint(ST_MakeLine(path_start, path_end), 
                LEAST(1, ST_LineLocatePoint(ST_MakeLine(path_start, path_end), geom) + nominal_speed / ST_Length(ST_MakeLine(path_start, path_end))))
            WHEN state = 'arriving' THEN ST_LineInterpolatePoint(ST_MakeLine(path_end, path_start), 
                LEAST(1, ST_LineLocatePoint(ST_MakeLine(path_end, path_start), geom) + nominal_speed / ST_Length(ST_MakeLine(path_end, path_start))))
            ELSE geom
        END,
        state = CASE
            WHEN (state = 'departing' AND geom = path_end) OR (state = 'arriving' AND geom = path_start) THEN 'stop'
            WHEN state = 'stop' AND NOW() >= last_stop_time + stop_duration THEN 
                CASE WHEN geom = path_start THEN 'departing' ELSE 'arriving' END
            ELSE state
        END,
        last_stop_time = CASE
            WHEN state = 'stop' AND NOW() >= last_stop_time + stop_duration THEN NOW()
            ELSE last_stop_time
        END,
        angle = 
          CASE
            WHEN state = 'departing' THEN 130
            WHEN state = 'stop' THEN 130
            WHEN state = 'arriving' THEN 310
          END;
END;
$$ LANGUAGE plpgsql;

SELECT cron.schedule('2 seconds', $$SELECT map_layers.update_ship_positions()$$);