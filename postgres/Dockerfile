FROM rust:1.85-slim-bookworm as rtiles-builder

RUN apt update && \
    apt install -y wget unzip \
        pkg-config libssl-dev openssl \
        clang llvm-dev libclang-dev build-essential \
        libreadline-dev \
        zlib1g-dev \
        bison flex && \
    mkdir /.pgrx && \
    PGRX_HOME=/.pgrx/ cargo install --locked --version 0.14.1 cargo-pgrx && \
    PGRX_HOME=/.pgrx/ cargo pgrx init --pg16 download

FROM rtiles-builder as rtiles

RUN wget https://github.com/gportenko/pg_rtiles/archive/refs/heads/master.zip -O pg_rtiles.zip && \
    unzip pg_rtiles.zip

WORKDIR /pg_rtiles-master/pg_rtiles
    
RUN PGRX_HOME=/.pgrx/ cargo pgrx install --pg-config /.pgrx/16.8/src/bin/pg_config/pg_config

FROM postgres:16.8

COPY --from=rtiles /.pgrx/16.8/pgrx-install/share/postgresql/extension/rtiles.control /usr/share/postgresql/16/extension/rtiles.control
COPY --from=rtiles /.pgrx/16.8/pgrx-install/share/postgresql/extension/rtiles--0.0.0.sql /usr/share/postgresql/16/extension/rtiles--0.0.0.sql
COPY --from=rtiles /.pgrx/16.8/pgrx-install/lib/postgresql/rtiles.so /usr/lib/postgresql/16/lib/rtiles.so

RUN apt update && \
    apt upgrade -y && \
    apt install -y --no-install-recommends \
    postgresql-16-cron \
    postgresql-16-postgis-3 && \
    rm -rf /var/lib/apt/lists/*

# postgresql.conf will be generated by postgres from this file on start
RUN echo "shared_preload_libraries = 'pg_cron'" >> /usr/share/postgresql/postgresql.conf.sample && \
    echo "cron.database_name = 'rtiles'" >> /usr/share/postgresql/postgresql.conf.sample 
    

